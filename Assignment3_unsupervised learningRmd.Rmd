---
title: "Assignment3_Unsupervised Learning"
author: "Daoyi Huang"
date: "2026-02-12"
output: html_document
---


# 1. Dataset Exploration</u></strong>      
## •Load and examine the Can Path Student Dataset (Not Imputed).  
## •Conduct an initial exploratory data analysis (EDA) to understand key features and relationships.      

In order to predict BMI, we need to identify the potential variables.  
•First step: Data cleaning
•Second step: Identify the continuous and categorical variables
•Third step: Check the correlation between continuous variables. If there are too mang continuos variables identified and there is multicollinearity existed, in order to pass the assumption of the absence of multicollinearity for linear regression model, we need to implement Principal Component Analysis (PCA) to reduce the dimension for the continuous variables and remove the multicollinearity.

**load the library **  
**Import the can_path_data dataset**  
```{r setup}
library(tidyverse)
library(tidymodels)
library(reportRmd)
library(sjPlot)
library(plotly)
library(psych)
library(parallel)
library(finalfit)
library(gtsummary)
library(mlbench)
library(vip)
library(rsample)
library(tune)
library(recipes)
library(yardstick)
library(parsnip)
library(glmnet)
library(themis)
library(corrr)
library(performance)
library(utils)
library(see)
data_canpath<-read.csv("/Users/xiehuangbao/Library/CloudStorage/OneDrive-UniversityofSaskatchewan/Study at USask/CHEP898_Machine Learning/can_path_data.csv")
```

```{r}
glimpse(data_canpath)
```
There are 440 variables identified, including "ID".   

```{r}
sum(duplicated(data_canpath))
```
There is no duplicated data existed in this "canpath" dataset.  


**Identify the candidates of continuous variables: **   
There are 1 outcome variables (BMI) and 34 continuous variables identified (including 1 outcome variable: PM_BMI_SR):   
-PM_BMI_SR (outcome variable) ~ BMI    
-SDC_AGE_CALC ~ Participant's age at questionnaire completion    
-SDC_EDU_LEVEL_AGE ~ Age at which the participant completed the highest level of education   
-WH_MENSTRUATION_AGE ~ Age of the female participant at menarche   
-WH_CONTRACEPTIVES_AGE ~ Age of the female participant when she started using hormonal contraceptives    
-WH_CONTRACEPTIVES_DURATION ~ Total duration (in months) of hormonal contraceptives use during the lifetime of the female participant   
-WH_PREG_FIRST_AGE ~ Age of female participant when she first became pregnant    
-WH_PREG_LAST_AGE ~ Age of the female participant when she last became pregnant    
-WH_MENOPAUSE_AGE~ Age of the female participant at menopause    
-WH_HYSTERECTOMY_AGE ~ Age of the female participant at hysterectomy   
-DIS_ARTHRITIS_AGE ~ Age of the participant at first diagnosis of arthritis  
-SLE_TIME ~ Number of minutes per day the participant usually sleeps, including naps   
-PSE_CHILDHOOD_DURATION  ~ Total duration of passive smoking exposure inside participant's home during childhood    
-PSE_ADULT_HOME_DURATION ~ Total duration of passive smoking exposure inside participant's home during adulthood     
-PSE_ADULT_WRK_DURATION  ~ Total duration of passive smoking exposure during adulthood at work   
-PA_WALK_TIME  ~ Average time per day spent doing walking activities in the last 7 days (IPAQ short form)    
-PA_TOTAL_MOD_SHORT ~ Quantitative indicator of the moderate intensity activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_WALK_SHORT ~ Quantitative indicator of the walking activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_SHORT ~ Quantitative indicator of global physical activity in metabolic equivalent (MET)-minutes per week (IPAQ short form)   
-PA_TOTAL_MOD_LONG ~ Quantitative indicator of the vigorous intensity activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_WALK_LONG ~ Quantitative indicator of the walking activities in metabolic equivalent (MET)-minutes/week (IPAQ long form)   
-PA_TOTAL_LONG ~ Quantitative indicator of global physical activity in metabolic equivalent (MET)-minutes per week (IPAQ long form)   
-PA_SIT_TIME_WKDAY ~ Average time spent sitting per week day in the last 7 days (IPAQ long form and short form)    
-PA_SIT_TIME_WKEND ~ Average time spent sitting per weekend day in the last 7 days (IPAQ  long form and short form)    
-PA_TOTAL_SIT_TIME ~ Total sitting time on average per week (IPAQ long form and short form)    
-PA_SIT_AVG_TIME_DAY ~ Average time spent sitting per day (IPAQ long form and short form)    
-PM_STAND_HEIGHT_SR_AVG ~ Average of the two vertical measurements or distance from the foot to the head of the participant when he/she is standing. Measure taken and reported by the participant    
-PM_WEIGHT_SR_AVG ~ Average of the two weight measurements. Measure taken and reported by the participant    
-PM_HIP_SR_AVG ~ Average of the two hip circumference measurements. Measure taken and reported by the participant    
-PM_WAIST_SR_AVG ~ Average of the two waist circumference measurements. Measure taken and reported by the participant    
-PM_WAIST_HIP_RATIO_SR ~ Ratio calculated using waist and hip circumference measurements. Measure taken and reported by the participant   
-NUT_VEG_QTY ~ Total number of vegetable servings (about 1/2 cup or 125mL) consumed in a typical day   
-NUT_FRUITS_QTY ~ Total number of fruit servings (about 1/2 cup) consumed in a typical day
-NUT_JUICE_QTY ~ "Total number of 100 percent fruit or vegetable juice servings  (125 mL or 1/2 cup) consumed in a typical day  
-ALC_CUR_FREQ ~ Frequency of alcohol consumption during the past 12 months  

Since we aare interested in the prediction of BMI for all the gender, we will exclude 7 variables only related to female, which are "WH_MENSTRUATION_AGE", "WH_CONTRACEPTIVES_AGE", "WH_CONTRACEPTIVES_DURATION", "WH_PREG_FIRST_AGE", "WH_PREG_LAST_AGE", "WH_MENOPAUSE_AGE", and "WH_HYSTERECTOMY_AGE".   

**Identify the candidates of categorical variables: There are 6 categorical variables.**    
-SDC_INCOME ~ income level
-SDC_GENDER ~ gender
-SMK_CIG_EVER ~ smoking consumption
-DIS_DIAB_EVER ~ diabetes status
-DIS_HBP_EVER ~ hypertension status
-DIS_ENDO_HB_CHOL_EVER ~ yperlipidemia status

Then there are 1 outcome variable (BMI), 27 continuous independent variables, and 6 categorical variables left. Next, we need to do the descriptive statistics for those variables.

```{r}
summary(data_canpath$PM_BMI_SR)
summary(data_canpath$SDC_AGE_CALC)
summary(data_canpath$SDC_EDU_LEVEL_AGE)
summary(data_canpath$DIS_ARTHRITIS_AGE)
summary(data_canpath$SLE_TIME)
summary(data_canpath$PSE_CHILDHOOD_DURATION)    
summary(data_canpath$PSE_ADULT_HOME_DURATION)  
summary(data_canpath$PSE_ADULT_WRK_DURATION) 
summary(data_canpath$PA_WALK_TIME)  
summary(data_canpath$PA_TOTAL_MOD_SHORT) 
summary(data_canpath$PA_TOTAL_WALK_SHORT) 
summary(data_canpath$PA_TOTAL_SHORT)
summary(data_canpath$PA_TOTAL_MOD_LONG) 
summary(data_canpath$PA_TOTAL_WALK_LONG) 
summary(data_canpath$PA_TOTAL_LONG) 
summary(data_canpath$PA_SIT_TIME_WKDAY)  
summary(data_canpath$PA_SIT_TIME_WKEND)    
summary(data_canpath$PA_TOTAL_SIT_TIME)   
summary(data_canpath$PA_SIT_AVG_TIME_DAY)  
summary(data_canpath$PM_STAND_HEIGHT_SR_AVG) 
summary(data_canpath$PM_WEIGHT_SR_AVG)  
summary(data_canpath$PM_HIP_SR_AVG) 
summary(data_canpath$PM_WAIST_SR_AVG) 
summary(data_canpath$PM_WAIST_HIP_RATIO_SR)
summary(data_canpath$NUT_VEG_QTY)  
summary(data_canpath$NUT_FRUITS_QTY)  
summary(data_canpath$NUT_JUICE_QTY)  
summary(data_canpath$ALC_CUR_FREQ) 
summary(data_canpath$SDC_INCOME) 
summary(data_canpath$SDC_GENDER) 
summary(data_canpath$SMK_CIG_EVER) 
summary(data_canpath$DIS_DIAB_EVER) 
summary(data_canpath$DIS_HBP_EVER) 
summary(data_canpath$DIS_ENDO_HB_CHOL_EVER) 
```

From the above summary result, we found 3 continuous variables (PA_TOTAL_MOD_LONG, PA_TOTAL_WALK_LONG, and PA_TOTAL_LONG) with more than 38600 missing data. We will exclude those 3 variables.

Now we have 1 outcome variable (BMI), 24 continuous independent variables, and 7 categorical variables. They are shown below.
-PM_BMI_SR (outcome variable)   
-SDC_AGE_CALC ~ Participant's age at questionnaire completion    
-SDC_EDU_LEVEL_AGE ~ Age at which the participant completed the highest level of education   
-DIS_ARTHRITIS_AGE ~ Age of the participant at first diagnosis of arthritis  
-SLE_TIME ~ Number of minutes per day the participant usually sleeps, including naps   
-PSE_CHILDHOOD_DURATION  ~ Total duration of passive smoking exposure inside participant's home during childhood    
-PSE_ADULT_HOME_DURATION ~ Total duration of passive smoking exposure inside participant's home during adulthood     
-PSE_ADULT_WRK_DURATION  ~ Total duration of passive smoking exposure during adulthood at work   
-PA_WALK_TIME  ~ Average time per day spent doing walking activities in the last 7 days (IPAQ short form)    
-PA_TOTAL_MOD_SHORT ~ Quantitative indicator of the moderate intensity activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_WALK_SHORT ~ Quantitative indicator of the walking activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_SHORT ~ Quantitative indicator of global physical activity in metabolic equivalent (MET)-minutes per week (IPAQ short form)   
-PA_SIT_TIME_WKDAY ~ Average time spent sitting per week day in the last 7 days (IPAQ long form and short form)    
-PA_SIT_TIME_WKEND ~ Average time spent sitting per weekend day in the last 7 days (IPAQ  long form and short form)    
-PA_TOTAL_SIT_TIME ~ Total sitting time on average per week (IPAQ long form and short form)    
-PA_SIT_AVG_TIME_DAY ~ Average time spent sitting per day (IPAQ long form and short form)    
-PM_STAND_HEIGHT_SR_AVG ~ Average of the two vertical measurements or distance from the foot to the head of the participant when he/she is standing. Measure taken and reported by the participant    
-PM_WEIGHT_SR_AVG ~ Average of the two weight measurements. Measure taken and reported by the participant    
-PM_HIP_SR_AVG ~ Average of the two hip circumference measurements. Measure taken and reported by the participant    
-PM_WAIST_SR_AVG ~ Average of the two waist circumference measurements. Measure taken and reported by the participant    
-PM_WAIST_HIP_RATIO_SR ~ Ratio calculated using waist and hip circumference measurements. Measure taken and reported by the participant
-NUT_VEG_QTY ~ Total number of vegetable servings (about 1/2 cup or 125mL) consumed in a typical day   
-NUT_FRUITS_QTY ~ Total number of fruit servings (about 1/2 cup) consumed in a typical day
-NUT_JUICE_QTY ~ "Total number of 100 percent fruit or vegetable juice servings  (125 mL or 1/2 cup) consumed in a typical day  
-ALC_CUR_FREQ ~ Frequency of alcohol consumption during the past 12 months   
-SDC_INCOME ~ income level
-SDC_GENDER ~ gender
-SMK_CIG_EVER ~ smoking consumption
-ALC_CUR_FREQ ~ alcohol consumption
-DIS_DIAB_EVER ~ diabetes status
-DIS_HBP_EVER ~ hypertension status
-DIS_ENDO_HB_CHOL_EVER ~ hyperlipidemia status


Keep the candidates for the above continuous variables and categorical variables.   
Following the literature, categorical variables (age, income level, alcohol consumption, smoking consumption, diabetes status, hypertension status, Hyperlipidemia status) will be included in our dataset.   
The 6 categorical variables will be changed to factor in R.
```{r}
data_canpath <- data_canpath |> select(ID,
                       PM_BMI_SR,
                       SDC_AGE_CALC, 
                       SDC_EDU_LEVEL_AGE,
                       DIS_ARTHRITIS_AGE,
                       SLE_TIME,
                       PSE_CHILDHOOD_DURATION,
                       PSE_ADULT_HOME_DURATION,
                       PSE_ADULT_WRK_DURATION,
                       PA_WALK_TIME,
                       PA_TOTAL_MOD_SHORT,
                       PA_TOTAL_WALK_SHORT,
                       PA_TOTAL_SHORT,
                       PA_SIT_TIME_WKDAY,
                       PA_SIT_TIME_WKEND,
                       PA_TOTAL_SIT_TIME,
                       PA_SIT_AVG_TIME_DAY,
                       PM_STAND_HEIGHT_SR_AVG,
                       PM_WEIGHT_SR_AVG,
                       PM_HIP_SR_AVG,
                       PM_WAIST_SR_AVG,
                       PM_WAIST_HIP_RATIO_SR,
                       NUT_VEG_QTY, 
                       NUT_FRUITS_QTY, 
                       NUT_JUICE_QTY, 
                       ALC_CUR_FREQ, 
                       SDC_INCOME,
                       SDC_GENDER,
                       SMK_CIG_EVER,
                       DIS_DIAB_EVER,
                       DIS_HBP_EVER,
                       DIS_ENDO_HB_CHOL_EVER)
data_canpath$SDC_INCOME <- as.factor(data_canpath$SDC_INCOME)
data_canpath$SDC_GENDER <- as.factor(data_canpath$SDC_GENDER)
data_canpath$SMK_CIG_EVER <- as.factor(data_canpath$SMK_CIG_EVER)
data_canpath$DIS_DIAB_EVER <- as.factor(data_canpath$DIS_DIAB_EVER)
data_canpath$DIS_HBP_EVER <- as.factor(data_canpath$DIS_HBP_EVER)
data_canpath$DIS_ENDO_HB_CHOL_EVER <- as.factor(data_canpath$DIS_ENDO_HB_CHOL_EVER)
```



```{r}
### 3 variables had variables coded as -7. 4 variables had extremely large values. Converting those to missing. 

data_canpath <- data_canpath %>% mutate(SDC_EDU_LEVEL_AGE = if_else(SDC_EDU_LEVEL_AGE < 0, NA_real_, SDC_EDU_LEVEL_AGE))
data_canpath <- data_canpath %>% mutate(DIS_ARTHRITIS_AGE = if_else(DIS_ARTHRITIS_AGE < 0, NA_real_, DIS_ARTHRITIS_AGE))
data_canpath <- data_canpath %>% mutate(ALC_CUR_FREQ = if_else(ALC_CUR_FREQ < 0, NA_real_, ALC_CUR_FREQ))

data_canpath <- data_canpath %>%
          mutate(PA_WALK_TIME = case_when(
            PA_WALK_TIME > 180 ~ 180,
            TRUE ~ PA_WALK_TIME
          ))


data_canpath <- data_canpath %>%
          mutate(PA_SIT_AVG_TIME_DAY = case_when(
            PA_SIT_AVG_TIME_DAY > 360 ~ 360,
            TRUE ~ PA_SIT_AVG_TIME_DAY
          ))

### Drop NA
data_canpath_clean <- drop_na(data_canpath)

rm_covsum(data=data_canpath_clean, 
covs=c('PM_BMI_SR','SDC_AGE_CALC', 'SDC_EDU_LEVEL_AGE', 'DIS_ARTHRITIS_AGE', 'SLE_TIME', 'PSE_CHILDHOOD_DURATION', 'PSE_ADULT_HOME_DURATION', 'PSE_ADULT_WRK_DURATION','PA_WALK_TIME', 'PA_TOTAL_MOD_SHORT', 'PA_TOTAL_WALK_SHORT', 'PA_TOTAL_SHORT', 'PA_SIT_TIME_WKDAY', 'PA_SIT_TIME_WKEND', 'PA_TOTAL_SIT_TIME', 'PA_SIT_AVG_TIME_DAY', 'PM_STAND_HEIGHT_SR_AVG', 'PM_WEIGHT_SR_AVG', 'PM_HIP_SR_AVG', 'PM_WAIST_SR_AVG', 'PM_WAIST_HIP_RATIO_SR', 'NUT_VEG_QTY', 'NUT_FRUITS_QTY', 'NUT_JUICE_QTY', 'ALC_CUR_FREQ', "SDC_INCOME", "SDC_GENDER", "SMK_CIG_EVER", "DIS_DIAB_EVER", "DIS_HBP_EVER", "DIS_ENDO_HB_CHOL_EVER"))

summary(data_canpath_clean$ALC_CUR_FREQ)  
```

After deleting the missing data, there are 761 samples left in our dataset.   

**Correlation check:**    

```{r}
data_canpath_clean %>% 
  correlate() %>%
  rearrange() %>%
  shave()  %>%
  rplot(print_cor=TRUE) +
  theme(axis.text.x = element_text(angle = 90))  
```
From the correlation plot, we found BMI is positive moderate correlated with weight average, waist circumference average, and hip circumference average. There are weak correlation or even no correlation between BMI and other continuous variables. Technically, it is not necessary to implement PCA for this dataset, since there are only 3 continuous variables which would included in our model.    

From the correlation table, we also found there are multicollinearity existed between the continuous independent variables. So for the sake of practice, we still implement PCA.


# 2. Baseline PCA Model</u></strong>    
## •Implement a baseline PCA model with default parameters.        
## •Evaluate the model using appropriate metrics.         
**Recipe**      
```{r}
pca_recipe <- recipe(~., data = data_canpath_clean) %>%
  update_role(ID, PM_BMI_SR, SDC_INCOME, SDC_GENDER, SMK_CIG_EVER, DIS_DIAB_EVER, DIS_HBP_EVER, DIS_ENDO_HB_CHOL_EVER, new_role = "id") %>%
  step_scale(all_predictors()) %>%
  step_center(all_predictors()) %>%
  step_pca(all_predictors(), id = "pca_id")

pca_recipe
```


**Prepare**     
```{r}
pca_prepared <- prep(pca_recipe)

pca_prepared
```

**Bake**    
```{r}
pca_baked <- bake(pca_prepared, data_canpath_clean)
pca_baked
```

The above table shows the score for each observation. The score stands for the possision for each observation in each principal component.

**Relationship between components**   
```{r}
pca_corr <- pca_baked |> select(-c(ID, PM_BMI_SR))

pca_corr %>% 
  correlate() %>%
  rearrange() %>%
  shave()  %>%
  rplot(print_cor=TRUE)
```

From the above correlation plot for each component, there is no correlation between those 5 components.


# 3. Cluster Selection Tuning        
## •Identify key decisions related to cluster selection       
## •Use techniques to find the optimal configuration         
## •Document the process using an RMarkdown File      


**Component loadings**  
```{r}
pca_variables <- tidy(pca_prepared, id = "pca_id", type = "coef")

ggplot(pca_variables) +
  geom_point(aes(x = value, y = terms, color = component))+
  labs(color = NULL) +
  geom_vline(xintercept=0) + 
  geom_vline(xintercept=-0.2, linetype = 'dashed') + 
  geom_vline(xintercept=0.2, linetype = 'dashed') + 
  facet_wrap(~ component) +
  theme_minimal()
ggsave("pca_loadings.pdf", width = 12, height = 14)
```
**Note:** The above PCA loading plot in the R is very difficult to figure out the variables. However, we can save the plot as PDF and we can identify the factors easily.

**Interpretation for the PCA loading plot:**  
•PCA1: There are 4 physical activity variables (PA_WALK_TIME, PA_TOTAL_WALK_SHORT, PA_TOTAL_SHORT, PA_TOTAL_MOD_SHORT) with loading value greater than 0.2. There are other 4 physical activity variables (PA_TOTAL_SIT_TIME, PA_SIT_TIME_WKEND, PA_SIT_TIME_WKDAYPA_SIT_AVG_TIME_DAY) with loading value below -0.2. This indicates the physical activity variables contribute most in principal component 1.     
**We can define principal component 1 as physical activity component.**   

•PCA2: There are 9 variables with loading value over than 0.2. They are:    
-age  
-weight   
-waist    
-passive smoking exposure inside participant's home during adulthood    
-passive smoking exposure during adulthood at work      
-physical activity: walk time perday and walk time short    
-Age of the participant at first diagnosis of arthritis     
This component is a combination of different categories of variables.    
**We can define principal component 2 as age-lifestyle component.**   

•PCA3: There are 7 variables with loading value over than 0.2 or below -0.2. They are:     
-weight     
-waist      
-hip circumference      
**We can define principal component 2 as physical measurement.**     

•PCA4: There are 3 variables with loading value over than 0.2, which are greater than their loading value in component 2. They are:     
-age  
-passive smoking exposure inside participant's home during adulthood    
-passive smoking exposure during adulthood at work        
-walk perday
-walk short
-Age of the participant at first diagnosis of arthritis  
-Alcohol consumption frequency
**Since there are mixed variables in component 4, it is hard to give it a theme. I just call it mixed factor**   
  

**Variance explained by components**  
```{r}
pca_variances <- tidy(pca_prepared, id = "pca_id", type = "variance")

pca_variance <- pca_variances |> filter(terms == "percent variance")
pca_variance$component <- as.factor(pca_variance$component)
pca_variance$comp <- as.numeric(pca_variance$component)

ggplot(pca_variance, aes(x = component, y = value, group = 1, color = component)) +
  geom_point() +
  geom_line() +
  labs(x = "Principal Components", y = "Variance explained (%)") +
  theme_minimal()
```

**Based on the above Variance explained by components plot, using the elbow method, I will keep 4 components in my PCA model.**    


**Cumulative percent variance**   
```{r}
pca_cummul_variance <- pca_variances |> filter(terms == "cumulative percent variance")
pca_cummul_variance$component <- as.factor(pca_cummul_variance$component)
pca_cummul_variance$comp <- as.numeric(pca_cummul_variance$component)

ggplot(pca_cummul_variance, aes(x = component, y = value, group = 1, color = component)) +
  geom_point() +
  geom_line() +
  labs(x = "Principal Components", y = "Cummulative Variance explained (%)") +
  theme_minimal()
```

Based on the above cumulative percent variance plot, 4 components can only explain 44% of variation, which is not good. The reason might be that we included lots variables which are not correlated or weak correlated to other variables. For the sake of practice, we still continue.    


**In summary, I kept 4 components. They are:**    
•PCA1: physical activity component      

•PCA2: age-lifestyle component      

•PCA3: physical measurement        

•PCA4: mixed factor(hard to give it a theme)       




# 4. PCA Regression Model Comparisons      
## •Conduct a PCA regression using your original cluster selection (Part 2 - Baseline PCA Model) and your tuned model (Part 3 - Cluster Select)         
## •Use BMI as the outcome variable for the PCA regression. This will Analyze differences in performance using quantitative metrics and discuss possible reasons for the results.           






# 5. Feature Importance Analysis    
## •Extract and interpret feature importance scores from the PCA regression from the best fitting model.             
## •Visualize the top contributing features and discuss their relevance to the dataset.        