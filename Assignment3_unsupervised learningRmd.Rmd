---
title: "Assignment3_Unsupervised Learning"
author: "Daoyi Huang"
date: "2026-02-15"
output: html_document
---

**I will use a significant level of 0.05 in this assignment.**    

# 1. Dataset Exploration</u></strong>      
## •Load and examine the Can Path Student Dataset (Not Imputed).  
## •Conduct an initial exploratory data analysis (EDA) to understand key features and relationships.      

In order to predict BMI, we need to identify the potential variables.  
•First step: Data cleaning    
•Second step: Identify the continuous and categorical variables   
•Third step: Check the correlation between continuous variables. If there are too mang continuos variables identified and there is multicollinearity existed, in order to pass the assumption of the absence of multicollinearity for linear regression model, we need to implement Principal Component Analysis (PCA) to reduce the dimension for the continuous variables and remove the multicollinearity.   

**load the library **  
**Import the can_path_data dataset**  
```{r setup}
library(tidyverse)
library(tidymodels)
library(reportRmd)
library(sjPlot)
library(plotly)
library(psych)
library(parallel)
library(finalfit)
library(gtsummary)
library(mlbench)
library(vip)
library(rsample)
library(tune)
library(recipes)
library(yardstick)
library(parsnip)
library(glmnet)
library(themis)
library(corrr)
library(performance)
library(utils)
library(see)
library(forestmodel)
data_canpath<-read.csv("/Users/xiehuangbao/Library/CloudStorage/OneDrive-UniversityofSaskatchewan/Study at USask/CHEP898_Machine Learning/can_path_data.csv")
```

```{r}
glimpse(data_canpath)
```
There are 440 variables identified, including "ID".   

```{r}
sum(duplicated(data_canpath))
```
There is no duplicated data existed in this "canpath" dataset.  


**Identify the candidates of continuous variables: **   
There are 1 outcome variables (BMI) and 34 continuous variables identified (including 1 outcome variable: PM_BMI_SR):   
-PM_BMI_SR (outcome variable) ~ BMI    
-SDC_AGE_CALC ~ Participant's age at questionnaire completion    
-SDC_EDU_LEVEL_AGE ~ Age at which the participant completed the highest level of education   
-WH_MENSTRUATION_AGE ~ Age of the female participant at menarche   
-WH_CONTRACEPTIVES_AGE ~ Age of the female participant when she started using hormonal contraceptives    
-WH_CONTRACEPTIVES_DURATION ~ Total duration (in months) of hormonal contraceptives use during the lifetime of the female participant   
-WH_PREG_FIRST_AGE ~ Age of female participant when she first became pregnant    
-WH_PREG_LAST_AGE ~ Age of the female participant when she last became pregnant    
-WH_MENOPAUSE_AGE~ Age of the female participant at menopause    
-WH_HYSTERECTOMY_AGE ~ Age of the female participant at hysterectomy   
-DIS_ARTHRITIS_AGE ~ Age of the participant at first diagnosis of arthritis  
-SLE_TIME ~ Number of minutes per day the participant usually sleeps, including naps   
-PSE_CHILDHOOD_DURATION  ~ Total duration of passive smoking exposure inside participant's home during childhood    
-PSE_ADULT_HOME_DURATION ~ Total duration of passive smoking exposure inside participant's home during adulthood     
-PSE_ADULT_WRK_DURATION  ~ Total duration of passive smoking exposure during adulthood at work   
-PA_WALK_TIME  ~ Average time per day spent doing walking activities in the last 7 days (IPAQ short form)    
-PA_TOTAL_MOD_SHORT ~ Quantitative indicator of the moderate intensity activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_WALK_SHORT ~ Quantitative indicator of the walking activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_SHORT ~ Quantitative indicator of global physical activity in metabolic equivalent (MET)-minutes per week (IPAQ short form)   
-PA_TOTAL_MOD_LONG ~ Quantitative indicator of the vigorous intensity activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_WALK_LONG ~ Quantitative indicator of the walking activities in metabolic equivalent (MET)-minutes/week (IPAQ long form)   
-PA_TOTAL_LONG ~ Quantitative indicator of global physical activity in metabolic equivalent (MET)-minutes per week (IPAQ long form)   
-PA_SIT_TIME_WKDAY ~ Average time spent sitting per week day in the last 7 days (IPAQ long form and short form)    
-PA_SIT_TIME_WKEND ~ Average time spent sitting per weekend day in the last 7 days (IPAQ  long form and short form)    
-PA_TOTAL_SIT_TIME ~ Total sitting time on average per week (IPAQ long form and short form)    
-PA_SIT_AVG_TIME_DAY ~ Average time spent sitting per day (IPAQ long form and short form)    
-PM_STAND_HEIGHT_SR_AVG ~ Average of the two vertical measurements or distance from the foot to the head of the participant when he/she is standing. Measure taken and reported by the participant    
-PM_WEIGHT_SR_AVG ~ Average of the two weight measurements. Measure taken and reported by the participant    
-PM_HIP_SR_AVG ~ Average of the two hip circumference measurements. Measure taken and reported by the participant    
-PM_WAIST_SR_AVG ~ Average of the two waist circumference measurements. Measure taken and reported by the participant    
-PM_WAIST_HIP_RATIO_SR ~ Ratio calculated using waist and hip circumference measurements. Measure taken and reported by the participant   
-NUT_VEG_QTY ~ Total number of vegetable servings (about 1/2 cup or 125mL) consumed in a typical day   
-NUT_FRUITS_QTY ~ Total number of fruit servings (about 1/2 cup) consumed in a typical day
-NUT_JUICE_QTY ~ "Total number of 100 percent fruit or vegetable juice servings  (125 mL or 1/2 cup) consumed in a typical day  
-ALC_CUR_FREQ ~ Frequency of alcohol consumption during the past 12 months  

Since we aare interested in the prediction of BMI for all the gender, we will exclude 7 variables only related to female, which are "WH_MENSTRUATION_AGE", "WH_CONTRACEPTIVES_AGE", "WH_CONTRACEPTIVES_DURATION", "WH_PREG_FIRST_AGE", "WH_PREG_LAST_AGE", "WH_MENOPAUSE_AGE", and "WH_HYSTERECTOMY_AGE".   

**Identify the candidates of categorical variables: There are 6 categorical variables.**    
-SDC_INCOME ~ income level
-SDC_GENDER ~ gender
-SMK_CIG_EVER ~ smoking consumption
-DIS_DIAB_EVER ~ diabetes status
-DIS_HBP_EVER ~ hypertension status
-DIS_ENDO_HB_CHOL_EVER ~ yperlipidemia status

Then there are 1 outcome variable (BMI), 27 continuous independent variables, and 6 categorical variables left. Next, we need to do the descriptive statistics for those variables.

```{r}
summary(data_canpath$PM_BMI_SR)
summary(data_canpath$SDC_AGE_CALC)
summary(data_canpath$SDC_EDU_LEVEL_AGE)
summary(data_canpath$DIS_ARTHRITIS_AGE)
summary(data_canpath$SLE_TIME)
summary(data_canpath$PSE_CHILDHOOD_DURATION)    
summary(data_canpath$PSE_ADULT_HOME_DURATION)  
summary(data_canpath$PSE_ADULT_WRK_DURATION) 
summary(data_canpath$PA_WALK_TIME)  
summary(data_canpath$PA_TOTAL_MOD_SHORT) 
summary(data_canpath$PA_TOTAL_WALK_SHORT) 
summary(data_canpath$PA_TOTAL_SHORT)
summary(data_canpath$PA_TOTAL_MOD_LONG) 
summary(data_canpath$PA_TOTAL_WALK_LONG) 
summary(data_canpath$PA_TOTAL_LONG) 
summary(data_canpath$PA_SIT_TIME_WKDAY)  
summary(data_canpath$PA_SIT_TIME_WKEND)    
summary(data_canpath$PA_TOTAL_SIT_TIME)   
summary(data_canpath$PA_SIT_AVG_TIME_DAY)  
summary(data_canpath$PM_STAND_HEIGHT_SR_AVG) 
summary(data_canpath$PM_WEIGHT_SR_AVG)  
summary(data_canpath$PM_HIP_SR_AVG) 
summary(data_canpath$PM_WAIST_SR_AVG) 
summary(data_canpath$PM_WAIST_HIP_RATIO_SR)
summary(data_canpath$NUT_VEG_QTY)  
summary(data_canpath$NUT_FRUITS_QTY)  
summary(data_canpath$NUT_JUICE_QTY)  
summary(data_canpath$ALC_CUR_FREQ) 
summary(data_canpath$SDC_INCOME) 
summary(data_canpath$SDC_GENDER) 
summary(data_canpath$SMK_CIG_EVER) 
summary(data_canpath$DIS_DIAB_EVER) 
summary(data_canpath$DIS_HBP_EVER) 
summary(data_canpath$DIS_ENDO_HB_CHOL_EVER) 
```

From the above summary result, we found 3 continuous variables (PA_TOTAL_MOD_LONG, PA_TOTAL_WALK_LONG, and PA_TOTAL_LONG) with more than 38600 missing data. We will exclude those 3 variables.

Now we have 1 outcome variable (BMI), 24 continuous independent variables, and 7 categorical variables. They are shown below.
-PM_BMI_SR (outcome variable)   
-SDC_AGE_CALC ~ Participant's age at questionnaire completion    
-SDC_EDU_LEVEL_AGE ~ Age at which the participant completed the highest level of education   
-DIS_ARTHRITIS_AGE ~ Age of the participant at first diagnosis of arthritis  
-SLE_TIME ~ Number of minutes per day the participant usually sleeps, including naps   
-PSE_CHILDHOOD_DURATION  ~ Total duration of passive smoking exposure inside participant's home during childhood    
-PSE_ADULT_HOME_DURATION ~ Total duration of passive smoking exposure inside participant's home during adulthood     
-PSE_ADULT_WRK_DURATION  ~ Total duration of passive smoking exposure during adulthood at work   
-PA_WALK_TIME  ~ Average time per day spent doing walking activities in the last 7 days (IPAQ short form)    
-PA_TOTAL_MOD_SHORT ~ Quantitative indicator of the moderate intensity activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_WALK_SHORT ~ Quantitative indicator of the walking activities in metabolic equivalent (MET)-minutes/week (IPAQ short form)   
-PA_TOTAL_SHORT ~ Quantitative indicator of global physical activity in metabolic equivalent (MET)-minutes per week (IPAQ short form)   
-PA_SIT_TIME_WKDAY ~ Average time spent sitting per week day in the last 7 days (IPAQ long form and short form)    
-PA_SIT_TIME_WKEND ~ Average time spent sitting per weekend day in the last 7 days (IPAQ  long form and short form)    
-PA_TOTAL_SIT_TIME ~ Total sitting time on average per week (IPAQ long form and short form)    
-PA_SIT_AVG_TIME_DAY ~ Average time spent sitting per day (IPAQ long form and short form)    
-PM_STAND_HEIGHT_SR_AVG ~ Average of the two vertical measurements or distance from the foot to the head of the participant when he/she is standing. Measure taken and reported by the participant    
-PM_WEIGHT_SR_AVG ~ Average of the two weight measurements. Measure taken and reported by the participant    
-PM_HIP_SR_AVG ~ Average of the two hip circumference measurements. Measure taken and reported by the participant    
-PM_WAIST_SR_AVG ~ Average of the two waist circumference measurements. Measure taken and reported by the participant    
-PM_WAIST_HIP_RATIO_SR ~ Ratio calculated using waist and hip circumference measurements. Measure taken and reported by the participant
-NUT_VEG_QTY ~ Total number of vegetable servings (about 1/2 cup or 125mL) consumed in a typical day   
-NUT_FRUITS_QTY ~ Total number of fruit servings (about 1/2 cup) consumed in a typical day
-NUT_JUICE_QTY ~ "Total number of 100 percent fruit or vegetable juice servings  (125 mL or 1/2 cup) consumed in a typical day  
-ALC_CUR_FREQ ~ Frequency of alcohol consumption during the past 12 months   
-SDC_INCOME ~ income level
-SDC_GENDER ~ gender
-SMK_CIG_EVER ~ smoking consumption
-ALC_CUR_FREQ ~ alcohol consumption
-DIS_DIAB_EVER ~ diabetes status
-DIS_HBP_EVER ~ hypertension status
-DIS_ENDO_HB_CHOL_EVER ~ hyperlipidemia status


Keep the candidates for the above continuous variables and categorical variables.   
Following the literature, categorical variables (age, income level, alcohol consumption, smoking consumption, diabetes status, hypertension status, Hyperlipidemia status) will be included in our dataset.   

```{r}
data_canpath <- data_canpath |> select(ID,
                       PM_BMI_SR,
                       SDC_AGE_CALC, 
                       SDC_EDU_LEVEL_AGE,
                       DIS_ARTHRITIS_AGE,
                       SLE_TIME,
                       PSE_CHILDHOOD_DURATION,
                       PSE_ADULT_HOME_DURATION,
                       PSE_ADULT_WRK_DURATION,
                       PA_WALK_TIME,
                       PA_TOTAL_MOD_SHORT,
                       PA_TOTAL_WALK_SHORT,
                       PA_TOTAL_SHORT,
                       PA_SIT_TIME_WKDAY,
                       PA_SIT_TIME_WKEND,
                       PA_TOTAL_SIT_TIME,
                       PA_SIT_AVG_TIME_DAY,
                       PM_STAND_HEIGHT_SR_AVG,
                       PM_WEIGHT_SR_AVG,
                       PM_HIP_SR_AVG,
                       PM_WAIST_SR_AVG,
                       PM_WAIST_HIP_RATIO_SR,
                       NUT_VEG_QTY, 
                       NUT_FRUITS_QTY, 
                       NUT_JUICE_QTY, 
                       ALC_CUR_FREQ, 
                       SDC_INCOME,
                       SDC_GENDER,
                       SMK_CIG_EVER,
                       DIS_DIAB_EVER,
                       DIS_HBP_EVER,
                       DIS_ENDO_HB_CHOL_EVER)
```



```{r}
### 3 variables had variables coded as -7. 4 variables had extremely large values. Converting those to missing. 

data_canpath <- data_canpath %>% mutate(SDC_EDU_LEVEL_AGE = if_else(SDC_EDU_LEVEL_AGE < 0, NA_real_, SDC_EDU_LEVEL_AGE))
data_canpath <- data_canpath %>% mutate(DIS_ARTHRITIS_AGE = if_else(DIS_ARTHRITIS_AGE < 0, NA_real_, DIS_ARTHRITIS_AGE))
data_canpath <- data_canpath %>% mutate(ALC_CUR_FREQ = if_else(ALC_CUR_FREQ < 0, NA_real_, ALC_CUR_FREQ))




data_canpath <- data_canpath %>%
          mutate(PA_WALK_TIME = case_when(
            PA_WALK_TIME > 180 ~ 180,
            TRUE ~ PA_WALK_TIME
          ))


data_canpath <- data_canpath %>%
          mutate(PA_SIT_AVG_TIME_DAY = case_when(
            PA_SIT_AVG_TIME_DAY > 360 ~ 360,
            TRUE ~ PA_SIT_AVG_TIME_DAY
          ))

### Drop NA
data_canpath_clean <- drop_na(data_canpath)

rm_covsum(data=data_canpath_clean, 
covs=c('PM_BMI_SR','SDC_AGE_CALC', 'SDC_EDU_LEVEL_AGE', 'DIS_ARTHRITIS_AGE', 'SLE_TIME', 'PSE_CHILDHOOD_DURATION', 'PSE_ADULT_HOME_DURATION', 'PSE_ADULT_WRK_DURATION','PA_WALK_TIME', 'PA_TOTAL_MOD_SHORT', 'PA_TOTAL_WALK_SHORT', 'PA_TOTAL_SHORT', 'PA_SIT_TIME_WKDAY', 'PA_SIT_TIME_WKEND', 'PA_TOTAL_SIT_TIME', 'PA_SIT_AVG_TIME_DAY', 'PM_STAND_HEIGHT_SR_AVG', 'PM_WEIGHT_SR_AVG', 'PM_HIP_SR_AVG', 'PM_WAIST_SR_AVG', 'PM_WAIST_HIP_RATIO_SR', 'NUT_VEG_QTY', 'NUT_FRUITS_QTY', 'NUT_JUICE_QTY', 'ALC_CUR_FREQ', "SDC_INCOME", "SDC_GENDER", "SMK_CIG_EVER", "DIS_DIAB_EVER", "DIS_HBP_EVER", "DIS_ENDO_HB_CHOL_EVER"))

### The 6 categorical variables will be changed to factor in R.   
data_canpath_clean$SDC_INCOME <- as.factor(data_canpath_clean$SDC_INCOME)
data_canpath_clean$SDC_GENDER <- as.factor(data_canpath_clean$SDC_GENDER)
data_canpath_clean$SMK_CIG_EVER <- as.factor(data_canpath_clean$SMK_CIG_EVER)
data_canpath_clean$DIS_DIAB_EVER <- as.factor(data_canpath_clean$DIS_DIAB_EVER)
data_canpath_clean$DIS_HBP_EVER <- as.factor(data_canpath_clean$DIS_HBP_EVER)
data_canpath_clean$DIS_ENDO_HB_CHOL_EVER <- as.factor(data_canpath_clean$DIS_ENDO_HB_CHOL_EVER)


summary(data_canpath_clean$SDC_INCOME) 
summary(data_canpath_clean$SDC_GENDER) 
summary(data_canpath_clean$SMK_CIG_EVER) 
summary(data_canpath_clean$DIS_DIAB_EVER) 
summary(data_canpath_clean$DIS_HBP_EVER) 
summary(data_canpath_clean$DIS_ENDO_HB_CHOL_EVER) 
```

After deleting the missing data, there are 761 samples left in our dataset.   

"DIS_DIAB_EVER", "DIS_HBP_EVER", and "DIS_ENDO_HB_CHOL_EVER" variables all have level 2 with only one observation, which is related to persumded disease status. We aims to split training data and testing data, it is better to delete level 2 for those 2 variables.    

**delete level 2 for "DIS_DIAB_EVER", "DIS_HBP_EVER", and "DIS_ENDO_HB_CHOL_EVER" variables**   
```{r}
data_canpath <- data_canpath %>% mutate(DIS_DIAB_EVER = if_else(DIS_DIAB_EVER >1, NA_real_, DIS_DIAB_EVER))
data_canpath <- data_canpath %>% mutate(DIS_HBP_EVER = if_else(DIS_HBP_EVER >1, NA_real_, DIS_HBP_EVER))
data_canpath <- data_canpath %>% mutate(DIS_ENDO_HB_CHOL_EVER = if_else(DIS_ENDO_HB_CHOL_EVER >1, NA_real_, DIS_ENDO_HB_CHOL_EVER))


### Drop NA
data_canpath_clean <- drop_na(data_canpath)

### The 6 categorical variables will be changed to factor in R.   
data_canpath_clean$SDC_INCOME <- as.factor(data_canpath_clean$SDC_INCOME)
data_canpath_clean$SDC_GENDER <- as.factor(data_canpath_clean$SDC_GENDER)
data_canpath_clean$SMK_CIG_EVER <- as.factor(data_canpath_clean$SMK_CIG_EVER)
data_canpath_clean$DIS_DIAB_EVER <- as.factor(data_canpath_clean$DIS_DIAB_EVER)
data_canpath_clean$DIS_HBP_EVER <- as.factor(data_canpath_clean$DIS_HBP_EVER)
data_canpath_clean$DIS_ENDO_HB_CHOL_EVER <- as.factor(data_canpath_clean$DIS_ENDO_HB_CHOL_EVER)


summary(data_canpath_clean$SDC_INCOME) 
summary(data_canpath_clean$SDC_GENDER) 
summary(data_canpath_clean$SMK_CIG_EVER) 
summary(data_canpath_clean$DIS_DIAB_EVER) 
summary(data_canpath_clean$DIS_HBP_EVER) 
summary(data_canpath_clean$DIS_ENDO_HB_CHOL_EVER) 
```


**Correlation check:**    

```{r}
data_canpath_clean %>% 
  correlate() %>%
  rearrange() %>%
  shave()  %>%
  rplot(print_cor=TRUE) +
  theme(axis.text.x = element_text(angle = 90))  
```
From the correlation plot, we found BMI is positive moderate correlated with weight average, waist circumference average, and hip circumference average. There are weak correlation or even no correlation between BMI and other continuous variables. Technically, it is not necessary to implement PCA for this dataset, since there are only 3 continuous variables which would included in our model.    

From the correlation table, we also found there are multicollinearity existed between the continuous independent variables. So for the sake of practice, we still implement PCA.


# 2. Baseline PCA Model</u></strong>    
## •Implement a baseline PCA model with default parameters.        
## •Evaluate the model using appropriate metrics.         
**Recipe**      
```{r}
pca_recipe <- recipe(~., data = data_canpath_clean) %>%
  update_role(ID, PM_BMI_SR, SDC_INCOME, SDC_GENDER, SMK_CIG_EVER, DIS_DIAB_EVER, DIS_HBP_EVER, DIS_ENDO_HB_CHOL_EVER, new_role = "id") %>%
  step_scale(all_predictors()) %>%
  step_center(all_predictors()) %>%
  step_pca(all_predictors(), id = "pca_id")

pca_recipe
```


**Prepare**     
```{r}
pca_prepared <- prep(pca_recipe)

pca_prepared
```

**Bake**    
```{r}
pca_baked <- bake(pca_prepared, data_canpath_clean)
pca_baked
```

The above table shows the score for each observation. The score stands for the possision for each observation in each principal component.

**Relationship between components**   
```{r}
pca_corr <- pca_baked |> select(-c(ID, PM_BMI_SR))

pca_corr %>% 
  correlate() %>%
  rearrange() %>%
  shave()  %>%
  rplot(print_cor=TRUE)
```

From the above correlation plot for each component, there is no correlation between those 5 components.


# 3. Cluster Selection Tuning        
## •Identify key decisions related to cluster selection       
## •Use techniques to find the optimal configuration         
## •Document the process using an RMarkdown File      


**Component loadings**  
```{r}
pca_variables <- tidy(pca_prepared, id = "pca_id", type = "coef")

ggplot(pca_variables) +
  geom_point(aes(x = value, y = terms, color = component))+
  labs(color = NULL) +
  geom_vline(xintercept=0) + 
  geom_vline(xintercept=-0.2, linetype = 'dashed') + 
  geom_vline(xintercept=0.2, linetype = 'dashed') + 
  facet_wrap(~ component) +
  theme_minimal()
ggsave("pca_loadings.pdf", width = 12, height = 14)
```
**Note:** The above PCA loading plot in the R is very difficult to figure out the variables. However, we can save the plot as PDF and we can identify the factors easily.

**Interpretation for the PCA loading plot:**  
•PCA1: There are 4 physical activity variables (PA_WALK_TIME, PA_TOTAL_WALK_SHORT, PA_TOTAL_SHORT, PA_TOTAL_MOD_SHORT) with loading value greater than 0.2. There are other 4 physical activity variables (PA_TOTAL_SIT_TIME, PA_SIT_TIME_WKEND, PA_SIT_TIME_WKDAYPA_SIT_AVG_TIME_DAY) with loading value below -0.2. This indicates the physical activity variables contribute most in principal component 1.     
**We can define principal component 1 as physical activity component.**   

•PCA2: There are 9 variables with loading value over than 0.2. They are:    
-age  
-weight   
-waist    
-passive smoking exposure inside participant's home during adulthood    
-passive smoking exposure during adulthood at work      
-physical activity: walk time perday and walk time short    
-Age of the participant at first diagnosis of arthritis     
This component is a combination of different categories of variables.    
**We can define principal component 2 as age-lifestyle component.**   

•PCA3: There are 7 variables with loading value over than 0.2 or below -0.2. They are:     
-weight     
-waist      
-hip circumference      
**We can define principal component 2 as physical measurement.**     

•PCA4: There are 3 variables with loading value over than 0.2, which are greater than their loading value in component 2. They are:     
-age  
-passive smoking exposure inside participant's home during adulthood    
-passive smoking exposure during adulthood at work        
-walk perday
-walk short
-Age of the participant at first diagnosis of arthritis  
-Alcohol consumption frequency    
**Since there are mixed variables in component 4, it is hard to give it a theme. I just call it mixed factor**   
  

**Variance explained by components**  
```{r}
pca_variances <- tidy(pca_prepared, id = "pca_id", type = "variance")

pca_variance <- pca_variances |> filter(terms == "percent variance")
pca_variance$component <- as.factor(pca_variance$component)
pca_variance$comp <- as.numeric(pca_variance$component)

ggplot(pca_variance, aes(x = component, y = value, group = 1, color = component)) +
  geom_point() +
  geom_line() +
  labs(x = "Principal Components", y = "Variance explained (%)") +
  theme_minimal()
```

**Based on the above Variance explained by components plot, using the elbow method, I will keep 4 components in my PCA model.**    


**Cumulative percent variance**   
```{r}
pca_cummul_variance <- pca_variances |> filter(terms == "cumulative percent variance")
pca_cummul_variance$component <- as.factor(pca_cummul_variance$component)
pca_cummul_variance$comp <- as.numeric(pca_cummul_variance$component)

ggplot(pca_cummul_variance, aes(x = component, y = value, group = 1, color = component)) +
  geom_point() +
  geom_line() +
  labs(x = "Principal Components", y = "Cummulative Variance explained (%)") +
  theme_minimal()
```

Based on the above cumulative percent variance plot, 4 components can only explain 44% of variation, which is not good. The reason might be that we included lots variables which are not correlated or weak correlated to other variables. For the sake of practice, we still continue.    


**In summary, I kept 4 components. They are:**    
•PCA1: physical activity component      

•PCA2: age-lifestyle component      

•PCA3: physical measurement        

•PCA4: mixed factor(hard to give it a theme)       



# 4. PCA Regression Model Comparisons      
## •Conduct a PCA regression using your original cluster selection (Part 2 - Baseline PCA Model) and your tuned model (Part 3 - Cluster Select)         
## •Use BMI as the outcome variable for the PCA regression. This will Analyze differences in performance using quantitative metrics and discuss possible reasons for the results.    

**Data Split**    
```{r}
set.seed(10)
data_split <- initial_split(data_canpath_clean, prop = 0.70)

train_data <- training(data_split)
summary(train_data$PM_BMI_SR)
summary(train_data$DIS_DIAB_EVER)
summary(train_data$DIS_ENDO_HB_CHOL_EVER)
summary(train_data$SDC_INCOME)
summary(train_data$SDC_GENDER)
summary(train_data$SMK_CIG_EVER)
summary(train_data$DIS_HBP_EVER)

test_data  <- testing(data_split)
summary(test_data$PM_BMI_SR)
summary(test_data$DIS_DIAB_EVER)
summary(test_data$DIS_ENDO_HB_CHOL_EVER)
summary(test_data$SDC_INCOME)
summary(test_data$SDC_GENDER)
summary(test_data$SMK_CIG_EVER)
summary(test_data$DIS_HBP_EVER)
```

The data_canpath_clean has been splited to training dataset (70%) and testing dataset (30%) randomly (set seed as 10). After checking the summary for training and testing dataset, their minimum, median, mean, maximum are close.    

We found that DIS_DIAB_EVER and DIS_ENDO_HB_CHOL_EVER variables have level 2 with only 1 observation.

**Model**   
```{r}
linear_model <- linear_reg() %>%
        set_engine("glm") %>%
        set_mode("regression") 
```


### Baseline PCA Model (including all the PCA components)   

**Recipe**    
```{r}
pca_reg_recipe <- recipe(PM_BMI_SR ~., data = train_data) %>%
  update_role(ID, new_role = "id") %>%
  step_scale(all_numeric_predictors()) %>%
  step_center(all_numeric_predictors()) %>%
  step_pca(all_numeric_predictors(), num_comp=20, id = "pca_id")

pca_reg_recipe
```

**Workflow**    
```{r}
bmi_workflow <- 
        workflow() %>%
        add_model(linear_model) %>% 
        add_recipe(pca_reg_recipe)

bmi_workflow
```

**Fit a model**
```{r}
bmi_fit <- 
  bmi_workflow %>% 
  fit(data = train_data)
```

```{r}
bmi_fit_extract <- bmi_fit %>% 
                    extract_fit_parsnip() %>% 
                    tidy()
bmi_fit_extract
```

**Predict on new data**  
```{r}
bmi_predicted <- augment(bmi_fit, test_data)

ggplot(bmi_predicted, aes(x = PM_BMI_SR, y = .pred)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Measured BMI", y = "Predicted BMI") +
  theme_minimal()
```



### Tuned model Model (kept components)   
**Recipe**    
```{r}
pca_reg_recipe_tuning <- recipe(PM_BMI_SR ~., data = train_data) %>%
  update_role(ID, new_role = "id") %>%
  step_scale(all_numeric_predictors()) %>%
  step_center(all_numeric_predictors()) %>%
  step_pca(all_numeric_predictors(), num_comp=4, id = "pca_id")

pca_reg_recipe_tuning
```

**Workflow**    
```{r}
bmi_workflow_tuning <- 
        workflow() %>%
        add_model(linear_model) %>% 
        add_recipe(pca_reg_recipe_tuning)

bmi_workflow_tuning
```

**Fit a model**
```{r}
bmi_fit_tuning <- 
  bmi_workflow_tuning %>% 
  fit(data = train_data)
```

```{r}
bmi_fit_extract_tuning <- bmi_fit_tuning %>% 
                    extract_fit_parsnip() %>% 
                    tidy()
bmi_fit_extract_tuning
```

**Predict on new data**  
```{r}
bmi_predicted_tuning <- augment(bmi_fit_tuning, test_data)

ggplot(bmi_predicted_tuning, aes(x = PM_BMI_SR, y = .pred)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Measured BMI", y = "Predicted BMI") +
  theme_minimal()
```

### Model evaluation (compare these 2 linear regression models)   
• Based on the two ggplots for measured BMI and predicated BMI from the 2 linear regression model using the original and tuning model, the dots are quite deviated from the line. In addition, the slopes of both the lines are smaller than 45°. Overall, both the 2 models perform similarly in predicting the BMI, and they do not predict the BMI very well. It is hard to tell which is better than another. We need to do more model evaluation to figure out which one is better.

**Diagnostic visulization**
```{r}
## linear regression model using the original PCA model
bmi_fit |> 
  extract_fit_engine() |> 
  check_model()
```
```{r}
## linear regression model using the tuning PCA model (4 components)
bmi_fit_tuning |> 
  extract_fit_engine() |> 
  check_model()
```
• Firstly, for both the 2 models, the normality of residuals plots show that the dots did not fall along the line well. I suspect that the normality assumption for both models are violated. In addition, for the regression model using the original PCA model, the assumption of Homogeneity is violated. Technically, their result are not trustworthy for me.       

• Secondly, based on the posterior predictive check plot, the linear regression model using the original PCA model might be slightly better than the one using tuning one.     

**Root Mean Squared Error**   
```{r}
## linear regression model using the original PCA model
rsq_test<- yardstick::rsq(data=bmi_predicted, truth = PM_BMI_SR,
         estimate = .pred)

rmse_test<- yardstick::rmse(data=bmi_predicted, truth = PM_BMI_SR,
         estimate = .pred)

rsq_test
rmse_test
```

```{r}
## linear regression model using the tuning PCA model
rsq_test<- yardstick::rsq(data=bmi_predicted_tuning, truth = PM_BMI_SR,
         estimate = .pred)

rmse_test<- yardstick::rmse(data=bmi_predicted_tuning, truth = PM_BMI_SR,
         estimate = .pred)

rsq_test
rmse_test
```

• The above tables show the coefficient determination (RSQ) and Root Mean Squared Error (RMSE) for testing dataset.  
• The RSQ of the linear regression model using the original PCA model is 0.507 which is higher than the one of using the tuning PCA model, which is 0.349. This indicates that the linear regression model using the original PCA model is a better model than the one using tuning PCA model. It can explain 50.7% of variation of the outcome variables.   
• The RMSE of the linear regression model using the original PCA model is 4.47 which is lower than the one of using the tuning PCA model, which is 5.08. Since lower RMSE, the better this model fits a dataset. So this indicates that the linear regression model using the original PCA model is a better model than the one using tuning PCA model.   
• Overall, based on the ggplots for measured BMI and predicated BMI, diagnositc visualization plots, RSQ, and RMSE based on the testing dataset, the linear regression model using the original (baseline) PCA model is a better model than the one using the tuning PCA model.     

# 5. Feature Importance Analysis    
## •Extract and interpret feature importance scores from the PCA regression from the best fitting model.              
## •Visualize the top contributing features and discuss their relevance to the dataset.   

**Our best PCA regression is the one using the original PCA model**
**Final model**   
```{r}
bmi_fit <- 
  bmi_workflow %>% 
  fit(data = train_data)
```

```{r}
bmi_fit_extract <- bmi_fit %>% 
                    extract_fit_parsnip() %>% 
                    tidy()
bmi_fit_extract
```

• From the above plots, I found all the categorical variables are not statistically significant. Most of the pricipal components are statistically significant (PC01, 02, 03, 05, 06, 07, 08, 09, 12, 13, 14, 15, 16, 18).    

**Check the PCA loading again**   
**Component loadings**  
```{r}
pca_variables <- tidy(pca_prepared, id = "pca_id", type = "coef")

ggplot(pca_variables) +
  geom_point(aes(x = value, y = terms, color = component))+
  labs(color = NULL) +
  geom_vline(xintercept=0) + 
  geom_vline(xintercept=-0.2, linetype = 'dashed') + 
  geom_vline(xintercept=0.2, linetype = 'dashed') + 
  facet_wrap(~ component) +
  theme_minimal()
ggsave("pca_loadings.pdf", width = 12, height = 14)
```

• I gave all the statistically significant PC a theme based on the variables which contribute most in each component.     
**Note:** The above PCA loading plot in the R is very difficult to figure out the variables. However, we can save the plot as PDF and we can identify the factors easily (I have also submitted the saved PDF in the Canvas).       

• PCA1: physical activity component        
• PCA2: age-lifestyle component       
• PCA3: physical measurement component        
• PCA5: vegetable and fruit consumption component   
• PCA6: mixed combination component   
• PCA7: mixed combination component     
• PCA8: mixed combination component   
• PCA9: mixed combination component   
• PCA12: mixed combination component    
• PCA13: mixed combination component    
• PCA14: mixed combination component    
• PCA15: mixed combination component    
• PCA16: mixed combination component    
• PCA518: mixed combination component       

**Visualize the top contributing features**   
**Forest plot**    
```{r}
### Best linear regression model using the original PCA model
lm_engine <- bmi_fit %>% extract_fit_engine()
forest_model(lm_engine)
```


•  The above forest plot visualizes both the statistically significant and non-significant features for the best linear regression model using the original PCA model.       

**Discuss their relevance to the dataset**    
•  All the categorical variables (income, gender, smoking status,diabetes status, hypertension status, and hyperlipidemia status) are found no statistically correlated with BMI. This may because that we excluded 98% dataset. We might miss lots of information.     

•  Most of the PCs are statistically significant, I was able to give some of them a theme, however, for many of the PCs, it is hard to give them a meaningful theme, because their top contributed variables are mixed.   

•  First PC is physical activity component. Physical activity contributes most in the first PC. This indicates physical activity is a good indicator for predict BMI. Look at the PC, I found that 4 physical activity variables (PA_WALK_TIME, PA_TOTAL_WALK_SHORT, PA_TOTAL_SHORT, PA_TOTAL_MOD_SHORT) with loading value greater than 0.2 and there are other 4 physical activity variables (PA_TOTAL_SIT_TIME, PA_SIT_TIME_WKEND, PA_SIT_TIME_WKDAYPA_SIT_AVG_TIME_DAY) with loading value below -0.2. This indicates sedentary lifestyle performs differently from walk activities, moderate intensity activities, and global physical activities.   

•  Second PC is age-lifestyle component. Age and passive smoking contribute most in second PC. This also makes sense. BMI is affected by people's age and lifestyle.    

•  Third PC is physical measurement component. This includes weight, wsist, and hip circumference measurements. Those physical measurement variables are correlated to people's BMI.    

•  The fifth PC is vegetable and fruit consumption component. This indicates that people's vegetable and fruit consumption is correlated to their BMI. As the PC loading for these variables are greater than 0.2 and regression coefficient for PC5 is -1.09 (-1.35, -0.82), the more fruits and vegetables people consume, the lower their BMI people tends to be.    

• It is difficult to interpret the other PCs, since their top contributors are mixed.   

**In summary**, since there is multicollinearity among our 24 potential continuous independent variables, I implemented the PCA to reduce the dimension of 24 continuous variables and to eliminate the multicollinearity to meet the assumption for the linear regression model. I got one baseline PCA model, and the tuning PCA model using cluser selection based on the elbow method. Then two PCA regression models were built using the training dataset. I compared these 2 PCA regression model using multiple method using testing dataset, including diagnosic visualization plots, coefficient determination (RSQ) and Root Mean Squared Error (RMSE). The PCA regression model using the baseline PCA model is a better model. This make sense. Because the tuning PCA molde with 4 components only explains 44% of vriation. It is better to used the baseline component to build the PCA regression model. For the significant variables, the physical activity component (PC1), age-lifestyle component (PC2), physical measurement component (PC3), and vegetable and fruit consumption component (PC5) are statistically significant. However, none of the categorical variables are found statistically significant.   


**Limitation:** Since he normality assumption is violated for both PCA regression models, the result for both models is not reliable. 
